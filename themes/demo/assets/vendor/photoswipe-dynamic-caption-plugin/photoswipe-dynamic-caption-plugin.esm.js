const defaultOptions={captionContent:".pswp-caption-content",type:"auto",horizontalEdgeThreshold:20,mobileCaptionOverlapRatio:.3,mobileLayoutBreakpoint:600};class PhotoSwipeDynamicCaption{constructor(i,t){this.options={...defaultOptions,...t},this.lightbox=i,this.lightbox.on("init",(()=>{this.initPlugin()}))}initPlugin(){this.pswp=this.lightbox.pswp,this.isCaptionHidden=!1,this.tempCaption=!1,this.captionElement=!1,this.pswp.on("uiRegister",(()=>{this.pswp.ui.registerElement({name:"dynamic-caption",order:9,isButton:!1,appendTo:"root",html:"",onInit:i=>{this.captionElement=i,this.initCaption()}})}))}initCaption(){const{pswp:i}=this;i.on("change",(()=>{this.updateCaptionHTML(),this.updateCurrentCaptionPosition(),this.showCaption()})),i.on("calcSlideSize",(i=>this.onCalcSlideSize(i))),i.on("moveMainScroll",(()=>{this.useMobileLayout()||(this.pswp.mainScroll.isShifted()?this.hideCaption():this.showCaption())})),i.on("zoomPanUpdate",(()=>{i.currSlide.currZoomLevel>i.currSlide.zoomLevels.initial?this.hideCaption():this.showCaption()})),i.on("beforeZoomTo",(t=>{const{currSlide:e}=i;e.__dcAdjustedPanAreaSize&&(t.destZoomLevel>e.zoomLevels.initial?(e.panAreaSize.x=e.__dcOriginalPanAreaSize.x,e.panAreaSize.y=e.__dcOriginalPanAreaSize.y):(e.panAreaSize.x=e.__dcAdjustedPanAreaSize.x,e.panAreaSize.y=e.__dcAdjustedPanAreaSize.y))}))}useMobileLayout(){const{mobileLayoutBreakpoint:i}=this.options;return"function"==typeof i?i.call(this):"number"==typeof i&&window.innerWidth<i}hideCaption(){this.isCaptionHidden||(this.isCaptionHidden=!0,this.captionElement.classList.add("pswp__dynamic-caption--faded"),this.captionFadeTimeout&&clearTimeout(this.captionFadeTimeout),this.captionFadeTimeout=setTimeout((()=>{this.captionElement.style.visibility="hidden",this.captionFadeTimeout=null}),400))}showCaption(){this.isCaptionHidden&&(this.isCaptionHidden=!1,this.captionElement.style.visibility="visible",clearTimeout(this.captionFadeTimeout),this.captionFadeTimeout=setTimeout((()=>{this.captionElement.classList.remove("pswp__dynamic-caption--faded"),this.captionFadeTimeout=null}),50))}setCaptionPosition(i,t){const e=i<=this.options.horizontalEdgeThreshold;this.captionElement.classList[e?"add":"remove"]("pswp__dynamic-caption--on-hor-edge"),this.captionElement.style.left=i+"px",this.captionElement.style.top=t+"px"}setCaptionWidth(i,t){t?i.style.width=t+"px":i.style.removeProperty("width")}setCaptionType(i,t){const e=i.dataset.pswpCaptionType;t!==e&&(i.classList.add("pswp__dynamic-caption--"+t),i.classList.remove("pswp__dynamic-caption--"+e),i.dataset.pswpCaptionType=t)}updateCurrentCaptionPosition(){const i=this.pswp.currSlide;if(!i.dynamicCaptionType)return;if("mobile"===i.dynamicCaptionType)return this.setCaptionType(this.captionElement,i.dynamicCaptionType),this.captionElement.style.removeProperty("left"),this.captionElement.style.removeProperty("top"),void this.setCaptionWidth(this.captionElement,!1);const t=i.zoomLevels.initial,e=Math.ceil(i.width*t),n=Math.ceil(i.height*t);this.setCaptionType(this.captionElement,i.dynamicCaptionType),"aside"===i.dynamicCaptionType?(this.setCaptionPosition(this.pswp.currSlide.bounds.center.x+e,this.pswp.currSlide.bounds.center.y),this.setCaptionWidth(this.captionElement,!1)):"below"===i.dynamicCaptionType&&(this.setCaptionPosition(this.pswp.currSlide.bounds.center.x,this.pswp.currSlide.bounds.center.y+n),this.setCaptionWidth(this.captionElement,e))}createTemporaryCaption(){this.tempCaption=document.createElement("div"),this.tempCaption.className="pswp__dynamic-caption pswp__dynamic-caption--temp",this.tempCaption.style.visibility="hidden",this.tempCaption.setAttribute("aria-hidden","true"),this.pswp.bg.after(this.captionElement),this.captionElement.after(this.tempCaption)}onCalcSlideSize(i){const{slide:t}=i;let e,n=!1;if(!this.getCaptionHTML(i.slide))return void(t.dynamicCaptionType=!1);this.storeOriginalPanAreaSize(t),t.bounds.update(t.zoomLevels.initial),this.useMobileLayout()?(t.dynamicCaptionType="mobile",n=!0):"auto"===this.options.type?t.bounds.center.x>t.bounds.center.y?t.dynamicCaptionType="aside":t.dynamicCaptionType="below":t.dynamicCaptionType=this.options.type;const o=Math.ceil(t.width*t.zoomLevels.initial),a=Math.ceil(t.height*t.zoomLevels.initial);if(this.tempCaption||this.createTemporaryCaption(),this.setCaptionType(this.tempCaption,t.dynamicCaptionType),"aside"===t.dynamicCaptionType){this.tempCaption.innerHTML=this.getCaptionHTML(i.slide),this.setCaptionWidth(this.tempCaption,!1),e=this.measureCaptionSize(this.tempCaption,i.slide);const n=e.x,a=o+t.bounds.center.x;t.panAreaSize.x-a<=n&&(t.panAreaSize.x-=n,this.recalculateZoomLevelAndBounds(t))}else if("below"===t.dynamicCaptionType||n){this.setCaptionWidth(this.tempCaption,n?this.pswp.viewportSize.x:o),this.tempCaption.innerHTML=this.getCaptionHTML(i.slide),e=this.measureCaptionSize(this.tempCaption,i.slide);const s=e.y,p=a+t.bounds.center.y,d=t.panAreaSize.y-p,c=t.panAreaSize.y;if(d<=s){t.panAreaSize.y-=Math.min(2*(s-d),s),this.recalculateZoomLevelAndBounds(t);const i=t.panAreaSize.x*this.options.mobileCaptionOverlapRatio/2;n&&t.bounds.center.x>i&&(t.panAreaSize.y=c,this.recalculateZoomLevelAndBounds(t))}}this.storeAdjustedPanAreaSize(t),t===this.pswp.currSlide&&this.updateCurrentCaptionPosition()}measureCaptionSize(i,t){const e=i.getBoundingClientRect();return this.pswp.dispatch("dynamicCaptionMeasureSize",{captionEl:i,slide:t,captionSize:{x:e.width,y:e.height}}).captionSize}recalculateZoomLevelAndBounds(i){i.zoomLevels.update(i.width,i.height,i.panAreaSize),i.bounds.update(i.zoomLevels.initial)}storeAdjustedPanAreaSize(i){i.__dcAdjustedPanAreaSize||(i.__dcAdjustedPanAreaSize={}),i.__dcAdjustedPanAreaSize.x=i.panAreaSize.x,i.__dcAdjustedPanAreaSize.y=i.panAreaSize.y}storeOriginalPanAreaSize(i){i.__dcOriginalPanAreaSize||(i.__dcOriginalPanAreaSize={}),i.__dcOriginalPanAreaSize.x=i.panAreaSize.x,i.__dcOriginalPanAreaSize.y=i.panAreaSize.y}getCaptionHTML(i){if("function"==typeof this.options.captionContent)return this.options.captionContent.call(this,i);const t=i.data.element;let e="";if(t){const i=t.querySelector(this.options.captionContent);if(i)e=i.innerHTML;else{const i=t.querySelector("img");i&&(e=i.getAttribute("alt"))}}return e}updateCaptionHTML(){const i=this.getCaptionHTML(pswp.currSlide);this.captionElement.style.visibility=i?"visible":"hidden",this.captionElement.innerHTML=i||"",this.pswp.dispatch("dynamicCaptionUpdateHTML",{captionElement:this.captionElement})}}export default PhotoSwipeDynamicCaption;
